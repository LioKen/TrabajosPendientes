<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trabajos Pendientes</title>

  <!-- Preload y enlaces a hojas de estilo externas -->
  <link rel="preload" href="normalize.css" as="style">
  <link rel="stylesheet" href="normalize.css">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto&display=swap" rel="stylesheet">
  
  <link rel="preload" href="style1.css" as="style">
  <link rel="stylesheet" href="style1.css">

  <!-- Estilos adicionales para autocompletado y header -->
</head>
<body>

    <div class="container">
        <h1>Registro de Trabajo Pendiente</h1>

        <div id="errorMessage" class="message error" style="display: none;"></div>
        <div id="confirmationMessage" class="message success" style="display: none;"></div>

        <form id="miFormulario">

            <fieldset>
                <legend>Detalles del Trabajo</legend>

                <label for="descripcion_trabajo">Descripción del Trabajo (*)</label>
                <textarea id="descripcion_trabajo" name="descripcion_trabajo" class="input-text" rows="3" required></textarea>
                
                <label for="maquinaInput">Máquina / Área (*)</label>
                <div class="autocomplete-container">
                    <input type="text" id="maquinaInput" name="maquina" class="input-text" placeholder="Buscar Máquina o Área" autocomplete="off" required>
                    <ul id="maquinaSuggestions" class="suggestions-list"></ul>
                    </div>
                
                <label for="asignado_aInput">Asignado a (*)</label>
                <div class="autocomplete-container">
                    <input type="text" id="asignado_aInput" name="asignado_a" class="input-text" placeholder="Buscar Técnico o Responsable" autocomplete="off" required>
                    <ul id="asignado_aSuggestions" class="suggestions-list"></ul>
                </div>

                <label for="prioridadSelect">Prioridad (*)</label>
                <select id="prioridadSelect" name="prioridad" class="input-text" required>
                    <option value="">Seleccionar</option>
                    <option value="Alta">Alta</option>
                    <option value="Media">Media</option>
                    <option value="Baja">Baja</option>
                </select>

                <label class="checkbox-label">
                    <input type="checkbox" id="requiere_seguimiento" name="requiere_seguimiento">
                    <span>Requiere Seguimiento Posterior</span>
                </label>
            </fieldset>

            <button type="button" id="toggleRepuestos" class="btn-toggle">
                ¿El trabajo requiere solicitar repuestos?
            </button>

            <div id="repuestos-seccion" style="display: none;">
                <fieldset>
                    <legend>Repuestos Requeridos</legend>
                    <div id="descripcion-container">
                        <div class="descripcion-item">
                            <label>Ítem 1</label>
                            <div class="input-group">
                                <div class="autocomplete-container repuesto-desc-container">
                                    <input type="text" name="descripcion_repuesto[]" class="input-text descripcion-input" placeholder="Descripción Repuesto (*)" autocomplete="off">
                                    <ul class="suggestions-list"></ul>
                                    <input type="hidden" name="codigo_repuesto[]" class="codigo-repuesto-hidden">
                                </div>

                                <input type="number" name="cantidad_requerida[]" class="input-text cantidad-input" placeholder="Cantidad (*)" min="1">
                                
                                <select name="und_de_medida[]" class="input-text und-medida-select">
                                    <option value="">Und. Medida (*)</option>
                                    </select>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addDescripcion" class="btn-add">+</button>
                </fieldset>
            </div>
            
            <button type="submit" class="btn-submit">Registrar Trabajo Pendiente</button>

            <div id="spinner" class="spinner" style="display: none;"></div>
        </form>
    </div>

    <script>
        // *** CONFIGURACIÓN ***
        // Reemplaza esta URL con la URL de despliegue de tu nueva App Web de Apps Script
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyMQsvf7hrN6Re5qmzql7fr3WQLt6mMQ62ShBrSq1YSvmtvrbZRUTNZkx6Ft2xzALc/exec';
        
        // Variables para almacenar datos (se cargan desde un JSON externo como en tus apps)
        let datosMaquina = [];
        let datosTecnico = []; // Usaremos esto para 'Asignado a'
        let datosRepuesto = [];
        let datosUndDeMedida = [];
        
        // Cargar datos desde opciones.json (Deberás subir este JSON a tu servidor web o cargarlo vía Apps Script)
  fetch('opciones.json')
    .then(response => response.json())
    .then(data => {
        // *** 1. ASIGNACIÓN DE DATOS (Mantenemos esta parte) ***
        datosMaquina = data.maquina || [];
        datosTecnico = data.tecnico || [];
        datosRepuesto = data.items || [];
        datosUndDeMedida = data.und_de_medida || [];

        // Poblar select de Unidad de Medida del primer ítem
        document.querySelectorAll('.und-medida-select').forEach(select => {
            populateUnidadSelect(select, datosUndDeMedida);
        });
        
        // Inicializar autocompletado para el primer input de repuesto
        setupAutocompleteForDescripcion(document.querySelector('.descripcion-input'));

        
        // *** 2. ¡LA SOLUCIÓN! MOVER LA INICIALIZACIÓN AQUÍ ADENTRO ***
        
        // Configurar autocompletado para MAQUINA
        const maquinaInput = document.getElementById('maquinaInput');
        const maquinaSuggestions = document.getElementById('maquinaSuggestions');
        setupAutocomplete(maquinaInput, maquinaSuggestions, datosMaquina);

        // Configurar autocompletado para ASIGNADO A (usando datos de Técnico)
        const asignadoInput = document.getElementById('asignado_aInput');
        const asignadoSuggestions = document.getElementById('asignado_aSuggestions');
        setupAutocomplete(asignadoInput, asignadoSuggestions, datosTecnico);

    })
    .catch(error => console.error('Error al cargar opciones.json:', error));

        /* --- FUNCIONES DE UTILIDAD Y AUTOCPMLETADO (Reutilizadas) --- */

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function populateUnidadSelect(selectElement, optionsArray) {
            optionsArray.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                selectElement.appendChild(option);
            });
        }

        function mostrarSugerencias(inputElement, suggestionsElement, datos, isRepuesto = false) {
            const query = inputElement.value.toLowerCase();
            suggestionsElement.innerHTML = '';
            
            let filtrados = [];
            // Filtramos por la propiedad 'descripcion' o si es un array simple de strings
            if (datos.length > 0 && typeof datos[0] === 'object') {
                filtrados = datos.filter(item => item.descripcion.toLowerCase().includes(query));
            } else {
                filtrados = datos.filter(item => item.toLowerCase().includes(query));
            }

            const fragment = document.createDocumentFragment();
            filtrados.forEach(item => {
                const li = document.createElement('li');
                const isObject = typeof item === 'object';
                
                li.textContent = isObject ? item.descripcion : item;
                if (isObject) {
                    li.setAttribute('data-codigo', item.codigo);
                }

                li.addEventListener('click', () => {
                    inputElement.value = isObject ? item.descripcion : item;
                    suggestionsElement.innerHTML = '';
                    
                    if (isRepuesto && isObject) {
                        // Lógica para guardar el código del repuesto en el input hidden
                        const container = inputElement.closest('.repuesto-desc-container');
                        let hiddenInput = container.querySelector('input.codigo-repuesto-hidden');
                        if (!hiddenInput) {
                            hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = 'codigo_repuesto[]';
                            hiddenInput.className = 'codigo-repuesto-hidden';
                            container.appendChild(hiddenInput);
                        }
                        hiddenInput.value = li.getAttribute('data-codigo') || '';
                    }
                });
                fragment.appendChild(li);
            });
            suggestionsElement.appendChild(fragment);
        }
        
        // Función general de autocompletado para Máquina y Asignado
        function setupAutocomplete(inputElement, suggestionsElement, dataArray) {
            inputElement.addEventListener('input', debounce(() => {
                mostrarSugerencias(inputElement, suggestionsElement, dataArray);
            }, 300));
        }

        // Función específica de autocompletado para Repuestos
        function setupAutocompleteForDescripcion(input) {
            const container = input.closest('.repuesto-desc-container');
            const suggestionsList = container.querySelector('.suggestions-list');
            input.addEventListener('input', debounce(function() {
                mostrarSugerencias(input, suggestionsList, datosRepuesto, true); // true para isRepuesto
            }, 300));
        }

        // Configurar autocompletado para MAQUINA
        const maquinaInput = document.getElementById('maquinaInput');
        const maquinaSuggestions = document.getElementById('maquinaSuggestions');
        setupAutocomplete(maquinaInput, maquinaSuggestions, datosMaquina);

        // Configurar autocompletado para ASIGNADO A (usando datos de Técnico)
        const asignadoInput = document.getElementById('asignado_aInput');
        const asignadoSuggestions = document.getElementById('asignado_aSuggestions');
        setupAutocomplete(asignadoInput, asignadoSuggestions, datosTecnico);

        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', e => {
            document.querySelectorAll('.autocomplete-container').forEach(container => {
                if (!container.contains(e.target)) {
                    container.querySelectorAll('.suggestions-list').forEach(list => list.innerHTML = '');
                }
            });
        });

        /* --- LÓGICA DE REPUESTOS Y SUBIDA DE DATOS --- */

        // Lógica para mostrar/ocultar la sección de repuestos (Nuevo)
        document.getElementById('toggleRepuestos').addEventListener('click', function() {
            const repuestosSection = document.getElementById('repuestos-seccion');
            const isHidden = repuestosSection.style.display === 'none';
            
            repuestosSection.style.display = isHidden ? 'block' : 'none';
            this.textContent = isHidden 
                ? 'Cancelar solicitud de repuestos' 
                : '¿El trabajo requiere solicitar repuestos?';

            // Si se muestra la sección, hacemos los campos requeridos. Si se oculta, los quitamos.
            repuestosSection.querySelectorAll('input[type="text"], input[type="number"], select').forEach(el => {
                el.required = isHidden;
            });
        });

        // Lógica para agregar nuevas filas de repuestos (Reutilizada de App 1)
        document.getElementById('addDescripcion').addEventListener('click', function() {
            const container = document.getElementById('descripcion-container');
            const lastIndex = container.querySelectorAll('.descripcion-item').length;
            
            const newDiv = document.createElement('div');
            newDiv.className = 'descripcion-item';
            newDiv.innerHTML = `
                <label>Ítem ${lastIndex + 1}</label>
                <div class="input-group">
                    <div class="autocomplete-container repuesto-desc-container">
                        <input type="text" name="descripcion_repuesto[]" class="input-text descripcion-input" placeholder="Descripción Repuesto (*)" autocomplete="off" required>
                        <ul class="suggestions-list"></ul>
                        <input type="hidden" name="codigo_repuesto[]" class="codigo-repuesto-hidden">
                    </div>
                    <input type="number" name="cantidad_requerida[]" class="input-text cantidad-input" placeholder="Cantidad (*)" min="1" required>
                    <select name="und_de_medida[]" class="input-text und-medida-select" required>
                        <option value="">Und. Medida (*)</option>
                    </select>
                </div>
            `;
            container.appendChild(newDiv);
            
            // Re-poblar y configurar el nuevo select y autocompletado
            const newDescInput = newDiv.querySelector('.descripcion-input');
            const newUmSelect = newDiv.querySelector('.und-medida-select');
            populateUnidadSelect(newUmSelect, datosUndDeMedida);
            setupAutocompleteForDescripcion(newDescInput);
        });

        // Envío del formulario con integración a Google Sheets
        document.getElementById('miFormulario').addEventListener('submit', function(e) {
            e.preventDefault();
            clearError();

            const form = this;
            const repuestosSection = document.getElementById('repuestos-seccion');
            const items = repuestosSection.style.display !== 'none' 
                ? document.querySelectorAll('#descripcion-container .descripcion-item')
                : [];
            
            // Recopilar arrays de repuestos (Lógica de App 1)
            let descripcionArray = [];
            let cantidadArray = [];
            let undArray = [];
            let codigoRepuestoArray = [];

            items.forEach(item => {
                const descInput = item.querySelector('input[name="descripcion_repuesto[]"]');
                const qtyInput = item.querySelector('input[name="cantidad_requerida[]"]');
                const umSelect = item.querySelector('select[name="und_de_medida[]"]');
                const hiddenCodigoInput = item.querySelector('input.codigo-repuesto-hidden');

                // Validaciones de repuestos opcionales
                if (descInput.value.trim() !== "") {
                     // Solo si hay descripción, se recopilan los demás datos.
                     // Aquí podrías agregar validaciones más estrictas si son requeridos
                     // (aunque la propiedad required del HTML ya debería manejarlo).
                    descripcionArray.push(descInput.value.trim());
                    cantidadArray.push(qtyInput.value.trim());
                    undArray.push(umSelect.value);
                    codigoRepuestoArray.push(hiddenCodigoInput && hiddenCodigoInput.value ? hiddenCodigoInput.value.trim() : "");
                }
            });

            // Recopilar datos principales del trabajo (Lógica de App 2)
            const data = {
                // Campos principales (coinciden con la Hoja 'TrabajosPendientes' en Apps Script)
                descripcion_trabajo: form.querySelector('textarea[name="descripcion_trabajo"]').value,
                maquina: maquinaInput.value,
                asignado_a: asignadoInput.value,
                prioridad: document.getElementById('prioridadSelect').value,
                requiere_seguimiento: document.getElementById('requiere_seguimiento').checked ? 'Sí' : 'No',
                
                // Arrays de repuestos (coinciden con la Hoja 'SolicitudRepuestos' en Apps Script)
                codigo_repuesto: codigoRepuestoArray,
                descripcion_repuesto: descripcionArray,
                cantidad_requerida: cantidadArray,
                und_de_medida: undArray
            };

            // Validación de campos principales... (puedes añadir más aquí si es necesario)
            if (data.prioridad === "" || data.descripcion_trabajo.trim() === "" || data.maquina.trim() === "" || data.asignado_a.trim() === "") {
                showError('Por favor, rellena todos los campos principales obligatorios (*).');
                return;
            }

            // Enviar datos
            const spinner = document.getElementById('spinner');
            const confirmationMessage = document.getElementById('confirmationMessage');
            spinner.style.display = 'block';
            confirmationMessage.style.display = 'none';

            fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(() => {
                spinner.style.display = 'none';
                confirmationMessage.textContent = 'El trabajo pendiente ha sido registrado correctamente.';
                confirmationMessage.style.display = 'block';
                form.reset();
                // Ocultar sección de repuestos después de enviar
                repuestosSection.style.display = 'none';
                document.getElementById('toggleRepuestos').textContent = '¿El trabajo requiere solicitar repuestos?';

            })
            .catch(error => {
                spinner.style.display = 'none';
                confirmationMessage.textContent = 'Error al registrar el trabajo. Por favor, intente de nuevo.';
                confirmationMessage.style.display = 'block';
                console.error('Error!', error.message);
            });
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        function clearError() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
        }
    </script>
</body>
</html>



