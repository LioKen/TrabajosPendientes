<!DOCTYPE html>
<html lang="es">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Falla Industrial</title>

    <link rel="stylesheet" href="normalize.css">
    
    <link rel="stylesheet" href="style1.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Bebas+Neue&display=swap" rel="stylesheet">
    
    </head>
<body>

    <form class="formulario" id="fallasForm">
        <div class="form-header">
            <svg class="header-icon-left" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M495.2 368.7c-5.7-18.3-15.6-35.1-28.5-49.6C448.3 301.6 422 288 394 288c-1.2 0-2.4 0-3.6 .1c2.1-15.2 3.6-31.1 3.6-48.1c0-14.7-1.7-28.9-4.8-42.5c23.5-12.8 45.4-30.8 63.8-53.1c11.2-13.8 20.3-29.3 27-45.9c3.2-8 3.2-16.7 0-24.7c-6.8-16.5-15.8-32.1-27.1-45.9C425.2 6.5 401.8 0 376 0c-43.2 0-82.9 20.8-107 54.3C258.9 57 256 57 253.1 54.3C228.9 20.8 189.2 0 146 0C120.2 0 96.8 6.5 76.7 19.3C65.5 33.1 56.5 48.7 49.8 65.3c-3.2 8-3.2 16.7 0 24.7c6.7 16.5 15.8 32.1 27.1 45.9c18.4 22.4 40.3 40.4 63.8 53.1c-3.1 13.6-4.8 27.8-4.8 42.5c0 17 1.5 32.9 3.6 48.1c-1.2-.1-2.4-.1-3.6-.1c-28 0-54.3 13.6-72.7 33.5c-12.9 14.5-22.8 31.3-28.5 49.6c-5.9 19.1-8.9 39.1-8.5 59.8c.6 27.1 11.2 53 29.8 74.3c18.5 21.3 43.8 37.6 72.1 47.9c11.1 4 22.8 6 34.6 6c18 0 35.7-3.9 51.5-11.6c4.6-2.2 9.5-2.2 14.1 0c15.8 7.7 33.5 11.6 51.5 11.6c11.8 0 23.5-2 34.6-6c28.3-10.3 53.6-26.6 72.1-47.9c18.6-21.3 29.2-47.2 29.8-74.3c.3-20.6-2.7-40.6-8.6-59.8zM256 368a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/></svg>
            <h2>Trabajos Pendientes</h2>
            <svg class="header-icon-right" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M495.2 368.7c-5.7-18.3-15.6-35.1-28.5-49.6C448.3 301.6 422 288 394 288c-1.2 0-2.4 0-3.6 .1c2.1-15.2 3.6-31.1 3.6-48.1c0-14.7-1.7-28.9-4.8-42.5c23.5-12.8 45.4-30.8 63.8-53.1c11.2-13.8 20.3-29.3 27-45.9c3.2-8 3.2-16.7 0-24.7c-6.8-16.5-15.8-32.1-27.1-45.9C425.2 6.5 401.8 0 376 0c-43.2 0-82.9 20.8-107 54.3C258.9 57 256 57 253.1 54.3C228.9 20.8 189.2 0 146 0C120.2 0 96.8 6.5 76.7 19.3C65.5 33.1 56.5 48.7 49.8 65.3c-3.2 8-3.2 16.7 0 24.7c6.7 16.5 15.8 32.1 27.1 45.9c18.4 22.4 40.3 40.4 63.8 53.1c-3.1 13.6-4.8 27.8-4.8 42.5c0 17 1.5 32.9 3.6 48.1c-1.2-.1-2.4-.1-3.6-.1c-28 0-54.3 13.6-72.7 33.5c-12.9 14.5-22.8 31.3-28.5 49.6c-5.9 19.1-8.9 39.1-8.5 59.8c.6 27.1 11.2 53 29.8 74.3c18.5 21.3 43.8 37.6 72.1 47.9c11.1 4 22.8 6 34.6 6c18 0 35.7-3.9 51.5-11.6c4.6-2.2 9.5-2.2 14.1 0c15.8 7.7 33.5 11.6 51.5 11.6c11.8 0 23.5-2 34.6-6c28.3-10.3 53.6-26.6 72.1-47.9c18.6-21.3 29.2-47.2 29.8-74.3c.3-20.6-2.7-40.6-8.6-59.8zM256 368a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/></svg>
        </div>

        <div id="errorMessage" class="error-message" style="display:none;"></div>
        <div id="confirmationMessage" style="display:none;"></div>
        
        <h3>1. Informaci√≥n de la Intervenci√≥n</h3>

        <div class="campo">
            <label for="ot">Orden de Trabajo (OT):</label>
            <input type="text" id="ot" name="ot" class="input-text" value="PENDIENTE" readonly>
        </div>

        <div style="display: flex; gap: 15px;">
            <div class="campo" style="flex: 1;">
                <label for="fecha_inicial">Fecha de Inicio del Evento:</label>
                <input type="date" id="fecha_inicial" name="fecha_inicial" class="input-text" required>
            </div>
            <div class="campo" style="flex: 1;">
                <label for="hora_inicial">Hora de Inicio del Evento:</label>
                <input type="time" id="hora_inicial" name="hora_inicial" class="input-text" required>
            </div>
        </div>

        <div class="campo">
            <label for="duracion">Duraci√≥n de la Intervenci√≥n (Ej: 2.5 hrs):</label>
            <input type="text" id="duracion" name="duracion" class="input-text" placeholder="Ej: 0.5, 2.5, 10" required>
        </div>
        
        <h3>2. Equipo y Responsables</h3>
        
        <div class="campo">
            <label for="codigo_maquina">C√≥digo de M√°quina:</label>
            <div class="autocomplete-container">
                <input type="text" id="codigo_maquina" name="codigo_maquina" class="input-text" placeholder="Escriba el c√≥digo de la m√°quina" required>
                <ul id="suggestions_cod_maq" class="suggestions-list"></ul>
            </div>
        </div>

        <div class="campo">
            <label for="descripcion_maquina">Descripci√≥n de M√°quina:</label>
            <div class="autocomplete-container">
                <input type="text" id="descripcion_maquina" name="descripcion_maquina" class="input-text" placeholder="Escriba la descripci√≥n de la m√°quina" required>
                <ul id="suggestions_desc_maq" class="suggestions-list"></ul>
            </div>
        </div>

        <div class="campo">
            <label for="tecnico">T√©cnico Asignado:</label>
            <select id="tecnico" name="tecnico" class="input-text" required>
                <option value="">-- Cargando T√©cnicos... --</option>
            </select>
        </div>

        <div class="campo">
            <label for="jefe_responsable">Jefe Responsable:</label>
            <select id="jefe_responsable" name="jefe_responsable" class="input-text" required>
                <option value="">-- Cargando Jefes... --</option>
            </select>
        </div>
        
        <div class="campo">
            <label for="tipo_de_pedido">Tipo de Pedido:</label>
            <select id="tipo_de_pedido" name="tipo_de_pedido" class="input-text" required>
                <option value="">-- Cargando Tipos... --</option>
            </select>
        </div>

        <h3>3. Detalle del Evento</h3>

        <div class="campo">
            <label for="tipo_de_actividad">Tipo de Actividad:</label>
            <select id="tipo_de_actividad" name="tipo_de_actividad" class="input-text" required>
                <option value="">-- Seleccione una Actividad --</option>
            </select>
        </div>

        <div class="campo">
            <label for="descripcion_evento">Descripci√≥n Detallada del Evento/Falla:</label>
            <textarea id="descripcion_evento" name="descripcion_evento" class="input-text" rows="4" placeholder="Describa la falla y las condiciones iniciales..." required></textarea>
        </div>
        
        <div class="campo">
            <label for="solucion_evento">Soluci√≥n Aplicada:</label>
            <textarea id="solucion_evento" name="solucion_evento" class="input-text" rows="4" placeholder="Describa los pasos y acciones tomadas para la reparaci√≥n..." required></textarea>
        </div>

        <div class="campo">
            <label for="causa_raiz">Causa Ra√≠z del Evento/Falla:</label>
            <textarea id="causa_raiz" name="causa_raiz" class="input-text" rows="2" placeholder="Ej: Falla mec√°nica por desgaste, error de operador..." required></textarea>
        </div>

        <div class="campo">
            <label for="estado_equipo">Estado del Equipo al Entregar:</label>
            <input type="text" id="estado_equipo" name="estado_equipo" class="input-text" placeholder="Ej: Operativo, Stand-by, Fuera de servicio (requiere repuesto)..." required>
        </div>
        
        <h3>4. Repuestos Utilizados (Opcional)</h3>

        <div id="moduloRepuestos">
            <div id="itemsContainer">
                </div>
            <button type="button" id="addItemBtn">‚ûï A√±adir Repuesto</button>
        </div>

        <h3>5. Verificaciones y Estado Final</h3>
        
        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="prueba_funcionalidad" value="on"> 
                ¬øSe realiz√≥ Prueba de Funcionalidad y fue exitosa?
            </label>
        </div>
        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="operando_normal" value="on"> 
                El equipo est√° operando en condiciones normales (Producci√≥n).
            </label>
        </div>
        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="requiere_seguimiento" value="on"> 
                El trabajo Requiere Seguimiento.
            </label>
        </div>
        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="no_operativa_intervencion" value="on"> 
                La m√°quina No qued√≥ operativa (Requiere intervenci√≥n adicional).
            </label>
        </div>
        
        <div class="campo">
            <label for="observaciones">Observaciones Adicionales:</label>
            <textarea id="observaciones" name="observaciones" class="input-text" rows="2" placeholder="Informaci√≥n relevante no cubierta por otros campos..."></textarea>
        </div>

        <button type="submit" class="boton" id="submitBtn">Enviar Reporte de Intervenci√≥n</button>
        
        <svg id="spinner" class="spinner" viewBox="0 0 50 50" style="display: none;">
            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
        </svg>

    </form>

    <footer>
        <p>Sistema Trabajos Pendientes - V1.0</p>
    </footer>

<script>
    // üî¥ 1. URL de la API de Apps Script (Ya la tienes bien definida)
    // ESTA DEBE SER LA URL DEL DESPLIEGUE CONFIGURADO como API (Execute as: User accessing the app)
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwqUvGiQGTd3vkiZ8FDKNvG47pZDsc8LrlX185e7EwOXI5DN8pGkXLlcay0ylw2Wnvl/exec';
    
    document.addEventListener('DOMContentLoaded', function() {
        let dataLists = {};
        
        // --- Funciones de Utilidad (SE MANTIENEN IGUAL) ---
        function loadSelectOptions(elementId, optionsArray) { 
            // ... (Tu funci√≥n de llenar SELECTs) ...
            const select = document.getElementById(elementId);
            if (select) {
                const placeholderText = select.options.length > 0 ? select.options[0].textContent : "-- Seleccione una Opci√≥n --";
                select.innerHTML = `<option value="">${placeholderText}</option>`;
                optionsArray.forEach(option => {
                    if (option) { 
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        select.appendChild(opt);
                    }
                });
            }
        }
        
        function setupAutocomplete(inputId, listKey) {
            // ... (Tu funci√≥n de autocompletado) ...
            const input = document.getElementById(inputId);
            const suggestionsList = input.parentNode.querySelector('.suggestions-list'); 

            if (!input || !suggestionsList || !dataLists[listKey]) return;

            const listSource = dataLists[listKey];

            input.addEventListener('input', function() {
                const val = input.value.toString().toLowerCase().trim();
                suggestionsList.innerHTML = '';
                
                if (val.length < 2) { 
                    suggestionsList.style.display = 'none';
                    return;
                }

                const filteredList = listSource.filter(item => 
                    item.toString().toLowerCase().includes(val)
                ).slice(0, 10);

                filteredList.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    li.addEventListener('click', () => {
                        input.value = item;
                        suggestionsList.style.display = 'none';
                    });
                    suggestionsList.appendChild(li);
                });

                suggestionsList.style.display = filteredList.length > 0 ? 'block' : 'none';
            });
            
            document.addEventListener('click', (e) => {
                if (e.target !== input && !suggestionsList.contains(e.target)) {
                    suggestionsList.style.display = 'none';
                }
            });
        }


        // --- M√≥dulo de Repuestos (SE MANTIENE IGUAL) ---
        const itemsContainer = document.getElementById('itemsContainer');
        const addItemBtn = document.getElementById('addItemBtn');
        let repuestoIndex = 0;

        function createRepuestoItem(index) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('item-repuesto');
            itemDiv.setAttribute('data-index', index);
            
            const itemHtml = `
                <div class="autocomplete-container">
                    <input type="text" id="repuesto_${index}_codigo" name="repuesto_${index}_codigo" class="input-text" placeholder="C√≥digo Repuesto">
                    <ul id="suggestions_rep_cod_${index}" class="suggestions-list"></ul>
                </div>
                
                <div class="autocomplete-container">
                    <input type="text" id="repuesto_${index}_descripcion" name="repuesto_${index}_descripcion" class="input-text" placeholder="Descripci√≥n Repuesto">
                    <ul id="suggestions_rep_desc_${index}" class="suggestions-list"></ul>
                </div>
                
                <input type="number" id="repuesto_${index}_cantidad" name="repuesto_${index}_cantidad" class="input-text cantidad-input" placeholder="Cant." min="0.01" step="any">
                
                <select id="repuesto_${index}_unidad" name="repuesto_${index}_unidad" class="input-text und-medida-select">
                    <option value="">UND</option>
                    </select>
                
                <button type="button" class="remove-item-btn" data-index="${index}">&times;</button>
            `;
            
            itemDiv.innerHTML = itemHtml;
            itemsContainer.appendChild(itemDiv);
            
            setupAutocomplete(`repuesto_${index}_codigo`, 'Codigo_Repuesto');
            setupAutocomplete(`repuesto_${index}_descripcion`, 'Descripcion_Repuesto');
            
            loadSelectOptions(`repuesto_${index}_unidad`, dataLists.Unidad_Medida || []);
            const defaultUnit = document.getElementById(`repuesto_${index}_unidad`);
            if (defaultUnit.options.length > 1) {
                defaultUnit.selectedIndex = 1; 
            }

            repuestoIndex++;
        }

        function removeRepuestoItem(indexToRemove) {
            const item = document.querySelector(`.item-repuesto[data-index="${indexToRemove}"]`);
            if (item) {
                item.remove();
            }
        }

        addItemBtn.addEventListener('click', () => createRepuestoItem(repuestoIndex));
        
        itemsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-item-btn')) {
                const indexToRemove = e.target.getAttribute('data-index');
                removeRepuestoItem(indexToRemove);
            }
        });

        // Crear el primer √≠tem al cargar la p√°gina
        createRepuestoItem(repuestoIndex); 


        // üî¥ 2. Carga Inicial de Datos (Cambiando a FETCH GET)
        // Antes: google.script.run...getInitialData();
        fetch(GAS_API_URL + '?method=getInitialData', {
            method: 'GET',
            mode: 'cors'
        })
        .then(response => response.json())
        .then(data => {
             // Asume que la respuesta JSON de GAS es: { success: true, initialData: {...} }
            if (data.success && data.initialData) {
                dataLists = data.initialData; // Usar data.initialData, no data directo
                
                // Configurar SELECTs Principales
                loadSelectOptions('tecnico', dataLists.Tecnico || []);
                loadSelectOptions('jefe_responsable', dataLists.Jefe_Responsable || []);
                loadSelectOptions('tipo_de_pedido', dataLists.Tipo_de_Pedido || []);
                loadSelectOptions('tipo_de_actividad', dataLists.Tipo_de_Actividad || []);
                
                // Configurar Autocompletado Principal
                setupAutocomplete('codigo_maquina', 'Codigo_Maquina');
                setupAutocomplete('descripcion_maquina', 'Descripcion_Maquina');

                // Actualizar todas las unidades de medida en el m√≥dulo de repuestos (incluido el primero)
                document.querySelectorAll('.und-medida-select').forEach(select => {
                    loadSelectOptions(select.id, dataLists.Unidad_Medida || []);
                });
            } else {
                onError(data.message || "Error al cargar datos iniciales del servidor.");
            }
        })
        .catch(error => {
            onError("Fallo de conexi√≥n de red al cargar datos iniciales.");
            console.error(error);
        });


        // --- Manejo del Env√≠o del Formulario ---
        const form = document.getElementById('fallasForm');
        const submitButton = document.getElementById('submitBtn');
        const spinner = document.getElementById('spinner');
        const errorDiv = document.getElementById('errorMessage');
        const confirmationDiv = document.getElementById('confirmationMessage');

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Ocultar mensajes previos
            errorDiv.style.display = 'none';
            confirmationDiv.style.display = 'none';

            // Mostrar spinner y deshabilitar bot√≥n
            spinner.style.display = 'block';
            submitButton.disabled = true;

            const formData = new FormData(form);
            
            // üî¥ 3. Env√≠o del Formulario (Cambiando a FETCH POST)
            // Antes: google.script.run...processForm(data);

            fetch(GAS_API_URL, {
                method: 'POST',
                // Convertimos FormData al formato que doPost(e) espera
                body: new URLSearchParams(formData), 
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                },
                mode: 'cors'
            })
            .then(response => response.json()) // Esperar la respuesta JSON de GAS
            .then(result => {
                onSuccess(result);
            })
            .catch(error => {
                onError("Error de conexi√≥n con el servidor. " + error.message);
                console.error(error);
            });
        });

        function onSuccess(result) {
            spinner.style.display = 'none';
            submitButton.disabled = false;
            
            if (result.success) {
                const otMsg = result.ot ? ` (OT: ${result.ot})` : '';
                confirmationDiv.textContent = `Reporte enviado exitosamente${otMsg}.`;
                confirmationDiv.style.display = 'block';
                form.reset(); 
                
                // Reiniciar el m√≥dulo de repuestos
                itemsContainer.innerHTML = '';
                repuestoIndex = 0;
                createRepuestoItem(0); 
            } else {
                onError(result.message || "Error desconocido al procesar el formulario.");
            }
        }

        function onError(error) {
            spinner.style.display = 'none';
            submitButton.disabled = false;
            errorDiv.textContent = 'Error: ' + (error.message || error.toString());
            errorDiv.style.display = 'block';
        }
    });
</script>
</body>
</html>



