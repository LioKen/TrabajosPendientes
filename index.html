<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trabajos Pendientes</title>

    <link rel="preload" href="normalize.css" as="style">
    <link rel="stylesheet" href="normalize.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto&display=swap" rel="stylesheet">
    
    <link rel="preload" href="style1.css" as="style">
    <link rel="stylesheet" href="style1.css">

    </head>
<body>

    <div class="container">
        <h1>Registro de Trabajo Pendiente</h1>

        <div id="errorMessage" class="message error" style="display: none;"></div>
        <div id="confirmationMessage" class="message success" style="display: none;"></div>

        <form id="miFormulario">

            <fieldset>
                <legend>Detalles del Trabajo</legend>

                <label for="descripcion_trabajo">Descripción del Trabajo (*)</label>
                <textarea id="descripcion_trabajo" name="descripcion_trabajo" class="input-text" rows="3" required></textarea>
                
                <label for="maquinaInput">Máquina / Área (*)</label>
                <div class="autocomplete-container">
                    <input type="text" id="maquinaInput" name="maquina" class="input-text" placeholder="Buscar Máquina o Área" autocomplete="off" required>
                    <ul id="maquinaSuggestions" class="suggestions-list"></ul>
                </div>
                
                <label for="jefe_responsable">Jefe Responsable (*)</label>
                <input type="text" id="jefe_responsable" name="jefe_responsable" class="input-text" placeholder="Nombre del Jefe o Supervisor" required>
                
                <label for="asignado_aInput">Asignado a (*)</label>
                <div class="autocomplete-container">
                    <input type="text" id="asignado_aInput" name="asignado_a" class="input-text" placeholder="Buscar Técnico o Responsable" autocomplete="off" required>
                    <ul id="asignado_aSuggestions" class="suggestions-list"></ul>
                </div>

                <label for="prioridadSelect">Prioridad (*)</label>
                <select id="prioridadSelect" name="prioridad" class="input-text" required>
                    <option value="">Seleccionar</option>
                    <option value="Alta">Alta</option>
                    <option value="Media">Media</option>
                    <option value="Baja">Baja</option>
                </select>

                <label class="checkbox-label">
                    <input type="checkbox" id="requiere_seguimiento" name="requiere_seguimiento" value="Sí">
                    <span>Requiere Seguimiento Posterior</span>
                </label>
            </fieldset>

            <fieldset>
                <legend>Evidencia Fotográfica</legend>
                <label for="foto_trabajo">Seleccionar Foto(s) de la falla:</label>
                <input type="file" id="foto_trabajo" name="foto_trabajo" accept="image/*" multiple>
                <p class="file-info">Puedes seleccionar hasta 2 imágenes (JPG, PNG).</p>
            </fieldset>

            <button type="button" id="toggleRepuestos" class="btn-toggle">
                ¿El trabajo requiere solicitar repuestos?
            </button>

            <div id="repuestos-seccion" style="display: none;">
                <fieldset>
                    <legend>Repuestos Requeridos</legend>
                    <div id="descripcion-container">
                        <div class="descripcion-item">
                            <label>Ítem 1</label>
                            <div class="input-group">
                                <div class="autocomplete-container repuesto-desc-container">
                                    <input type="text" name="descripcion_repuesto[]" class="input-text descripcion-input" placeholder="Descripción Repuesto (*)" autocomplete="off">
                                    <ul class="suggestions-list"></ul>
                                    <input type="hidden" name="codigo_repuesto[]" class="codigo-repuesto-hidden">
                                </div>

                                <input type="number" name="cantidad_requerida[]" class="input-text cantidad-input" placeholder="Cantidad (*)" min="1">
                                
                                <select name="und_de_medida[]" class="input-text und-medida-select">
                                    <option value="">Und. Medida (*)</option>
                                    </select>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addDescripcion" class="btn-add">+</button>
                </fieldset>
            </div>
            
            <button type="submit" class="btn-submit" id="submitButton">Registrar Trabajo Pendiente</button>

            <div id="spinner" class="spinner" style="display: none;"></div>
        </form>
    </div>

    <script>
        // *** CONFIGURACIÓN ***
        // Reemplaza esta URL con la URL de despliegue de tu nueva App Web de Apps Script
        const scriptURL = 'https://script.google.com/macros/s/AKfycbypeDB1A9rgzR4c6VsxAxHshD2wNyIdW3U0_MZq1MyzSHWBfGXZyVGxxVD2foyn-FJF/exec';
        
        // Variables para almacenar datos (se cargan desde opciones.json)
        let datosMaquina = [];
        let datosTecnico = [];
        let datosRepuesto = [];
        let datosUndDeMedida = [];
        
        // Cargar datos desde opciones.json
        fetch('opciones.json')
            .then(response => response.json())
            .then(data => {
                // 1. ASIGNACIÓN DE DATOS 
                datosMaquina = data.maquina || [];
                datosTecnico = data.tecnico || [];
                datosRepuesto = data.items || [];
                datosUndDeMedida = data.und_de_medida || [];

                // Poblar select de Unidad de Medida del primer ítem
                document.querySelectorAll('.und-medida-select').forEach(select => {
                    populateUnidadSelect(select, datosUndDeMedida);
                });
                
                // Inicializar autocompletado para el primer input de repuesto
                setupAutocompleteForDescripcion(document.querySelector('.descripcion-input'));
                
                // Configurar autocompletado para MAQUINA
                const maquinaInput = document.getElementById('maquinaInput');
                const maquinaSuggestions = document.getElementById('maquinaSuggestions');
                setupAutocomplete(maquinaInput, maquinaSuggestions, datosMaquina);

                // Configurar autocompletado para ASIGNADO A (usando datos de Técnico)
                const asignadoInput = document.getElementById('asignado_aInput');
                const asignadoSuggestions = document.getElementById('asignado_aSuggestions');
                setupAutocomplete(asignadoInput, asignadoSuggestions, datosTecnico);

            })
            .catch(error => console.error('Error al cargar opciones.json:', error));

        /* --- FUNCIONES DE UTILIDAD Y AUTOCPMLETADO (Reutilizadas) --- */

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function populateUnidadSelect(selectElement, optionsArray) {
            optionsArray.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                selectElement.appendChild(option);
            });
        }

        function mostrarSugerencias(inputElement, suggestionsElement, datos, isRepuesto = false) {
            const query = inputElement.value.toLowerCase();
            suggestionsElement.innerHTML = '';
            
            let filtrados = [];
            
            if (datos.length > 0 && typeof datos[0] === 'object') {
                filtrados = datos.filter(item => item.descripcion.toLowerCase().includes(query));
            } else {
                filtrados = datos.filter(item => item.toLowerCase().includes(query));
            }
            
            if (query.length < 2 || filtrados.length === 0) return;

            const fragment = document.createDocumentFragment();
            filtrados.forEach(item => {
                const li = document.createElement('li');
                const isObject = typeof item === 'object';
                
                li.textContent = isObject ? item.descripcion : item;
                
                if (isObject) {
                    li.setAttribute('data-codigo', item.codigo);
                }

                li.addEventListener('click', () => {
                    inputElement.value = isObject ? item.descripcion : item;
                    suggestionsElement.innerHTML = '';
                    
                    if (isRepuesto && isObject) {
                        const container = inputElement.closest('.repuesto-desc-container');
                        let hiddenInput = container.querySelector('input.codigo-repuesto-hidden');
                        hiddenInput.value = li.getAttribute('data-codigo') || '';
                    }
                });
                fragment.appendChild(li);
            });
            suggestionsElement.appendChild(fragment);
        }
        
        function setupAutocomplete(inputElement, suggestionsElement, dataArray) {
            inputElement.addEventListener('input', debounce(() => {
                mostrarSugerencias(inputElement, suggestionsElement, dataArray);
            }, 300));
        }

        function setupAutocompleteForDescripcion(input) {
            const container = input.closest('.repuesto-desc-container');
            const suggestionsList = container.querySelector('.suggestions-list');
            input.addEventListener('input', debounce(function() {
                mostrarSugerencias(input, suggestionsList, datosRepuesto, true);
            }, 300));
        }

        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', e => {
            document.querySelectorAll('.autocomplete-container').forEach(container => {
                if (!container.contains(e.target)) {
                    container.querySelectorAll('.suggestions-list').forEach(list => list.innerHTML = '');
                }
            });
        });

        /* --- LÓGICA DE REPUESTOS Y SUBIDA DE DATOS --- */

        // Lógica para mostrar/ocultar la sección de repuestos
        document.getElementById('toggleRepuestos').addEventListener('click', function() {
            const repuestosSection = document.getElementById('repuestos-seccion');
            const isHidden = repuestosSection.style.display === 'none';
            
            repuestosSection.style.display = isHidden ? 'block' : 'none';
            this.textContent = isHidden 
                ? 'Cancelar solicitud de repuestos' 
                : '¿El trabajo requiere solicitar repuestos?';

            // Si se muestra la sección, hacemos los campos requeridos.
            repuestosSection.querySelectorAll('input[type="text"], input[type="number"], select').forEach(el => {
                el.required = isHidden;
            });
        });

        // Lógica para agregar nuevas filas de repuestos
        document.getElementById('addDescripcion').addEventListener('click', function() {
            const container = document.getElementById('descripcion-container');
            const lastIndex = container.querySelectorAll('.descripcion-item').length;
            
            const newDiv = document.createElement('div');
            newDiv.className = 'descripcion-item';
            newDiv.innerHTML = `
                <label>Ítem ${lastIndex + 1}</label>
                <div class="input-group">
                    <div class="autocomplete-container repuesto-desc-container">
                        <input type="text" name="descripcion_repuesto[]" class="input-text descripcion-input" placeholder="Descripción Repuesto (*)" autocomplete="off" required>
                        <ul class="suggestions-list"></ul>
                        <input type="hidden" name="codigo_repuesto[]" class="codigo-repuesto-hidden">
                    </div>
                    <input type="number" name="cantidad_requerida[]" class="input-text cantidad-input" placeholder="Cantidad (*)" min="1" required>
                    <select name="und_de_medida[]" class="input-text und-medida-select" required>
                        <option value="">Und. Medida (*)</option>
                    </select>
                </div>
            `;
            container.appendChild(newDiv);
            
            const newDescInput = newDiv.querySelector('.descripcion-input');
            const newUmSelect = newDiv.querySelector('.und-medida-select');
            populateUnidadSelect(newUmSelect, datosUndDeMedida);
            setupAutocompleteForDescripcion(newDescInput);
        });

        // Validación de límite de archivos
        document.getElementById('foto_trabajo').addEventListener('change', function() {
            clearError();
            if (this.files.length > 2) {
                showError('Solo puedes subir un máximo de 2 fotos para la evidencia.');
                this.value = null; // Limpia la selección
            }
        });


        // Envío del formulario con integración a Google Sheets
        document.getElementById('miFormulario').addEventListener('submit', function(e) {
            e.preventDefault();
            clearError();

            const form = this;
            const repuestosSection = document.getElementById('repuestos-seccion');

            // Validación básica de campos requeridos
            if (!form.checkValidity()) {
                showError('Por favor, rellena todos los campos obligatorios (*) y revisa el límite de fotos.');
                return;
            }

            const spinner = document.getElementById('spinner');
            const submitButton = document.getElementById('submitButton');
            spinner.style.display = 'block';
            submitButton.disabled = true;
            document.getElementById('confirmationMessage').style.display = 'none';
            
            // *** CAMBIO CRÍTICO: USO DE FORM DATA ***
            // FormData recopila todos los campos por 'name', incluyendo las fotos y arrays de repuestos.
            const formData = new FormData(form);

            // Limpieza de campos de repuestos si la sección no está visible
                if (repuestosSection.style.display === 'none') {
                formData.delete('descripcion_repuesto');
                formData.delete('cantidad_requerida');
                formData.delete('und_de_medida');
                formData.delete('codigo_repuesto');
            }

            // Enviar datos
            fetch(scriptURL, {
                method: 'POST',
                // El Content-Type se establece automáticamente como multipart/form-data por FormData
                body: formData
            })
            .then(response => {
                // Leer la respuesta (asumiendo que Apps Script devuelve JSON o un texto)
                return response.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch {
                        // Respuesta vacía o no JSON = éxito en entorno no-cors
                        return { result: "Success" }; 
                    }
                });
            })
            .then(result => {
                spinner.style.display = 'none';
                submitButton.disabled = false;

                if (result.result === "Error") {
                    showError(`Error al registrar el trabajo: ${result.message}`);
                    return;
                }

                document.getElementById('confirmationMessage').textContent = `El trabajo pendiente (ID: ${result.trabajoID || 'N/A'}) ha sido registrado y el correo enviado.`;
                document.getElementById('confirmationMessage').style.display = 'block';
                form.reset();
                
                // Ocultar sección de repuestos después de enviar
                repuestosSection.style.display = 'none';
                document.getElementById('toggleRepuestos').textContent = '¿El trabajo requiere solicitar repuestos?';

            })
            .catch(error => {
                spinner.style.display = 'none';
                submitButton.disabled = false;
                showError('Error de red o comunicación. Por favor, intente de nuevo.');
                console.error('Error!', error.message);
            });
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('confirmationMessage').style.display = 'none';
        }
        function clearError() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
        }
    </script>
</body>
</html>





