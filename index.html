<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trabajo Pendiente</title>
    <?!= HtmlService.createHtmlOutputFromFile('normalize').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('style1').getContent() ?>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Bebas+Neue&display=swap" rel="stylesheet">
</head>
<body>

    <form class="formulario" id="fallasForm">
        <div class="form-header">
            <svg class="header-icon-left" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M495.2 368.7c-5.7-18.3-15.6-35.1-28.5-49.6C448.3 301.6 422 288 394 288c-1.2 0-2.4 0-3.6 .1c2.1-15.2 3.6-31.1 3.6-48.1c0-14.7-1.7-28.9-4.8-42.5c23.5-12.8 45.4-30.8 63.8-53.1c11.2-13.8 20.3-29.3 27-45.9c3.2-8 3.2-16.7 0-24.7c-6.8-16.5-15.8-32.1-27.1-45.9C425.2 6.5 401.8 0 376 0c-43.2 0-82.9 20.8-107 54.3C258.9 57 256 57 253.1 54.3C228.9 20.8 189.2 0 146 0C120.2 0 96.8 6.5 76.7 19.3C65.5 33.1 56.5 48.7 49.8 65.3c-3.2 8-3.2 16.7 0 24.7c6.7 16.5 15.8 32.1 27.1 45.9c18.4 22.4 40.3 40.4 63.8 53.1c-3.1 13.6-4.8 27.8-4.8 42.5c0 17 1.5 32.9 3.6 48.1c-1.2-.1-2.4-.1-3.6-.1c-28 0-54.3 13.6-72.7 33.5c-12.9 14.5-22.8 31.3-28.5 49.6c-5.9 19.1-8.9 39.1-8.5 59.8c.6 27.1 11.2 53 29.8 74.3c18.5 21.3 43.8 37.6 72.1 47.9c11.1 4 22.8 6 34.6 6c18 0 35.7-3.9 51.5-11.6c4.6-2.2 9.5-2.2 14.1 0c15.8 7.7 33.5 11.6 51.5 11.6c11.8 0 23.5-2 34.6-6c28.3-10.3 53.6-26.6 72.1-47.9c18.6-21.3 29.2-47.2 29.8-74.3c.3-20.6-2.7-40.6-8.6-59.8zM256 368a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/></svg>
            <h2>Trabajos Pendientes</h2>
            <svg class="header-icon-right" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M495.2 368.7c-5.7-18.3-15.6-35.1-28.5-49.6C448.3 301.6 422 288 394 288c-1.2 0-2.4 0-3.6 .1c2.1-15.2 3.6-31.1 3.6-48.1c0-14.7-1.7-28.9-4.8-42.5c23.5-12.8 45.4-30.8 63.8-53.1c11.2-13.8 20.3-29.3 27-45.9c3.2-8 3.2-16.7 0-24.7c-6.8-16.5-15.8-32.1-27.1-45.9C425.2 6.5 401.8 0 376 0c-43.2 0-82.9 20.8-107 54.3C258.9 57 256 57 253.1 54.3C228.9 20.8 189.2 0 146 0C120.2 0 96.8 6.5 76.7 19.3C65.5 33.1 56.5 48.7 49.8 65.3c-3.2 8-3.2 16.7 0 24.7c6.7 16.5 15.8 32.1 27.1 45.9c18.4 22.4 40.3 40.4 63.8 53.1c-3.1 13.6-4.8 27.8-4.8 42.5c0 17 1.5 32.9 3.6 48.1c-1.2-.1-2.4-.1-3.6-.1c-28 0-54.3 13.6-72.7 33.5c-12.9 14.5-22.8 31.3-28.5 49.6c-5.9 19.1-8.9 39.1-8.5 59.8c.6 27.1 11.2 53 29.8 74.3c18.5 21.3 43.8 37.6 72.1 47.9c11.1 4 22.8 6 34.6 6c18 0 35.7-3.9 51.5-11.6c4.6-2.2 9.5-2.2 14.1 0c15.8 7.7 33.5 11.6 51.5 11.6c11.8 0 23.5-2 34.6-6c28.3-10.3 53.6-26.6 72.1-47.9c18.6-21.3 29.2-47.2 29.8-74.3c.3-20.6-2.7-40.6-8.6-59.8zM256 368a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/></svg>
        </div>

        <div id="errorMessage" class="error-message" style="display:none;"></div>
        <div id="confirmationMessage" style="display:none;"></div>
        
        <h3>1. Información de la Intervención</h3>

        <div class="campo">
            <label for="ot">Orden de Trabajo (OT):</label>
            <input type="text" id="ot" name="ot" class="input-text" value="PENDIENTE" readonly>
        </div>

        <div style="display: flex; gap: 15px;">
            <div class="campo" style="flex: 1;">
                <label for="fecha_inicial">Fecha de Inicio del Evento:</label>
                <input type="date" id="fecha_inicial" name="fecha_inicial" class="input-text" required>
            </div>
            <div class="campo" style="flex: 1;">
                <label for="hora_inicial">Hora de Inicio del Evento:</label>
                <input type="time" id="hora_inicial" name="hora_inicial" class="input-text" required>
            </div>
        </div>

        <div class="campo">
            <label for="duracion">Duración de la Intervención (Ej: 2.5 hrs):</label>
            <input type="text" id="duracion" name="duracion" class="input-text" placeholder="Ej: 0.5, 2.5, 10" required>
        </div>
        
        <h3>2. Equipo y Responsables</h3>
        
        <div class="campo">
            <label for="codigo_maquina">Código de Máquina:</label>
            <div class="autocomplete-container">
                <input type="text" id="codigo_maquina" name="codigo_maquina" class="input-text" placeholder="Escriba el código de la máquina" required>
                <ul id="suggestions_cod_maq" class="suggestions-list"></ul>
            </div>
        </div>

        <div class="campo">
            <label for="descripcion_maquina">Descripción de Máquina:</label>
            <div class="autocomplete-container">
                <input type="text" id="descripcion_maquina" name="descripcion_maquina" class="input-text" placeholder="Escriba la descripción de la máquina" required>
                <ul id="suggestions_desc_maq" class="suggestions-list"></ul>
            </div>
        </div>

        <div class="campo">
            <label for="tecnico">Técnico Asignado:</label>
            <select id="tecnico" name="tecnico" class="input-text" required>
                <option value="">-- Cargando Técnicos... --</option>
            </select>
        </div>

        <div class="campo">
            <label for="jefe_responsable">Jefe Responsable:</label>
            <select id="jefe_responsable" name="jefe_responsable" class="input-text" required>
                <option value="">-- Cargando Jefes... --</option>
            </select>
        </div>
        
        <div class="campo">
            <label for="tipo_de_pedido">Tipo de Pedido:</label>
            <select id="tipo_de_pedido" name="tipo_de_pedido" class="input-text" required>
                <option value="">-- Cargando Tipos... --</option>
            </select>
        </div>

        <h3>3. Detalle del Evento</h3>

        <div class="campo">
            <label for="tipo_de_actividad">Tipo de Actividad:</label>
            <select id="tipo_de_actividad" name="tipo_de_actividad" class="input-text" required>
                <option value="">-- Seleccione una Actividad --</option>
            </select>
        </div>

        <div class="campo">
            <label for="descripcion_evento">Descripción Detallada del Evento/Falla:</label>
            <textarea id="descripcion_evento" name="descripcion_evento" class="input-text" rows="4" placeholder="Describa la falla y las condiciones iniciales..." required></textarea>
        </div>
        
        <div class="campo">
            <label for="solucion_evento">Solución Aplicada:</label>
            <textarea id="solucion_evento" name="solucion_evento" class="input-text" rows="4" placeholder="Describa los pasos y acciones tomadas para la reparación..." required></textarea>
        </div>

        <div class="campo">
            <label for="causa_raiz">Causa Raíz del Evento/Falla:</label>
            <textarea id="causa_raiz" name="causa_raiz" class="input-text" rows="2" placeholder="Ej: Falla mecánica por desgaste, error de operador..." required></textarea>
        </div>

        <div class="campo">
            <label for="estado_equipo">Estado del Equipo al Entregar:</label>
            <input type="text" id="estado_equipo" name="estado_equipo" class="input-text" placeholder="Ej: Operativo, Stand-by, Fuera de servicio (requiere repuesto)..." required>
        </div>
        
        <h3>4. Repuestos Utilizados (Opcional)</h3>

        <div id="moduloRepuestos">
            <div id="itemsContainer">
                </div>
            <button type="button" id="addItemBtn">➕ Añadir Repuesto</button>
        </div>

        <h3>5. Verificaciones y Estado Final</h3>
        
        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="prueba_funcionalidad" value="on"> 
                ¿Se realizó Prueba de Funcionalidad y fue exitosa?
            </label>
        </div>
        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="operando_normal" value="on"> 
                El equipo está operando en condiciones normales (Producción).
            </label>
        </div>
        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="requiere_seguimiento" value="on"> 
                El trabajo Requiere Seguimiento.
            </label>
        </div>
        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="no_operativa_intervencion" value="on"> 
                La máquina No quedó operativa (Requiere intervención adicional).
            </label>
        </div>
        
        <div class="campo">
            <label for="observaciones">Observaciones Adicionales:</label>
            <textarea id="observaciones" name="observaciones" class="input-text" rows="2" placeholder="Información relevante no cubierta por otros campos..."></textarea>
        </div>

        <button type="submit" class="boton" id="submitBtn">Enviar Reporte de Intervención</button>
        
        <svg id="spinner" class="spinner" viewBox="0 0 50 50" style="display: none;">
            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
        </svg>

    </form>

    <footer>
        <p>Sistema Trabajos Pendientes - V1.0</p>
    </footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Almacenes de listas (cargadas desde la hoja DATA)
        let dataLists = {};
        
        // --- Funciones de Utilidad ---

        // 1. Llenar SELECTs
        function loadSelectOptions(elementId, optionsArray) {
            const select = document.getElementById(elementId);
            if (select) {
                const placeholderText = select.options.length > 0 ? select.options[0].textContent : "-- Seleccione una Opción --";
                select.innerHTML = `<option value="">${placeholderText}</option>`;
                optionsArray.forEach(option => {
                    if (option) { // Evita opciones vacías
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        select.appendChild(opt);
                    }
                });
            }
        }
        
        // 2. Configurar Autocompletado para un input específico
        function setupAutocomplete(inputId, listKey) {
            const input = document.getElementById(inputId);
            // Busca el <ul> dentro del mismo contenedor de autocompletado
            const suggestionsList = input.parentNode.querySelector('.suggestions-list'); 

            if (!input || !suggestionsList || !dataLists[listKey]) return;

            const listSource = dataLists[listKey];

            input.addEventListener('input', function() {
                const val = input.value.toString().toLowerCase().trim();
                suggestionsList.innerHTML = '';
                
                if (val.length < 2) { // Muestra sugerencias a partir de 2 caracteres
                    suggestionsList.style.display = 'none';
                    return;
                }

                const filteredList = listSource.filter(item => 
                    item.toString().toLowerCase().includes(val)
                ).slice(0, 10);

                filteredList.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    li.addEventListener('click', () => {
                        input.value = item;
                        suggestionsList.style.display = 'none';
                    });
                    suggestionsList.appendChild(li);
                });

                suggestionsList.style.display = filteredList.length > 0 ? 'block' : 'none';
            });
            
            document.addEventListener('click', (e) => {
                if (e.target !== input && !suggestionsList.contains(e.target)) {
                    suggestionsList.style.display = 'none';
                }
            });
        }


        // --- Módulo de Repuestos ---
        const itemsContainer = document.getElementById('itemsContainer');
        const addItemBtn = document.getElementById('addItemBtn');
        let repuestoIndex = 0;

        function createRepuestoItem(index) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('item-repuesto');
            itemDiv.setAttribute('data-index', index);
            
            const itemHtml = `
                <div class="autocomplete-container">
                    <input type="text" id="repuesto_${index}_codigo" name="repuesto_${index}_codigo" class="input-text" placeholder="Código Repuesto">
                    <ul id="suggestions_rep_cod_${index}" class="suggestions-list"></ul>
                </div>
                
                <div class="autocomplete-container">
                    <input type="text" id="repuesto_${index}_descripcion" name="repuesto_${index}_descripcion" class="input-text" placeholder="Descripción Repuesto">
                    <ul id="suggestions_rep_desc_${index}" class="suggestions-list"></ul>
                </div>
                
                <input type="number" id="repuesto_${index}_cantidad" name="repuesto_${index}_cantidad" class="input-text cantidad-input" placeholder="Cant." min="0.01" step="any">
                
                <select id="repuesto_${index}_unidad" name="repuesto_${index}_unidad" class="input-text und-medida-select">
                    <option value="">UND</option>
                    </select>
                
                <button type="button" class="remove-item-btn" data-index="${index}">&times;</button>
            `;
            
            itemDiv.innerHTML = itemHtml;
            itemsContainer.appendChild(itemDiv);
            
            // 3. Configurar Autocompletado para este nuevo item
            setupAutocomplete(`repuesto_${index}_codigo`, 'Codigo_Repuesto');
            setupAutocomplete(`repuesto_${index}_descripcion`, 'Descripcion_Repuesto');
            
            // 4. Llenar el Select de Unidad de Medida
            loadSelectOptions(`repuesto_${index}_unidad`, dataLists.Unidad_Medida || []);
            // Ajustar el valor por defecto para que muestre UND o KG
            const defaultUnit = document.getElementById(`repuesto_${index}_unidad`);
            if (defaultUnit.options.length > 1) {
                defaultUnit.selectedIndex = 1; // Selecciona la primera unidad cargada
            }

            repuestoIndex++;
        }

        function removeRepuestoItem(indexToRemove) {
            const item = document.querySelector(`.item-repuesto[data-index="${indexToRemove}"]`);
            if (item) {
                item.remove();
            }
        }

        addItemBtn.addEventListener('click', () => createRepuestoItem(repuestoIndex));
        
        // Manejador para eliminar el item
        itemsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-item-btn')) {
                const indexToRemove = e.target.getAttribute('data-index');
                removeRepuestoItem(indexToRemove);
            }
        });

        // Crear el primer ítem al cargar la página
        createRepuestoItem(repuestoIndex); 


        // --- Carga Inicial de Datos (Google Apps Script) ---
        google.script.run.withSuccessHandler(data => {
            // Guardar todas las listas de la hoja DATA
            dataLists = data; 

            // Configurar SELECTs Principales
            loadSelectOptions('tecnico', dataLists.Tecnico || []);
            loadSelectOptions('jefe_responsable', dataLists.Jefe_Responsable || []);
            loadSelectOptions('tipo_de_pedido', dataLists.Tipo_de_Pedido || []);
            loadSelectOptions('tipo_de_actividad', dataLists.Tipo_de_Actividad || []);
            
            // Configurar Autocompletado Principal
            setupAutocomplete('codigo_maquina', 'Codigo_Maquina');
            setupAutocomplete('descripcion_maquina', 'Descripcion_Maquina');

            // Actualizar todas las unidades de medida en el módulo de repuestos (incluido el primero)
            document.querySelectorAll('.und-medida-select').forEach(select => {
                loadSelectOptions(select.id, dataLists.Unidad_Medida || []);
            });

        }).getInitialData();


        // --- Manejo del Envío del Formulario ---
        const form = document.getElementById('fallasForm');
        const submitButton = document.getElementById('submitBtn');
        const spinner = document.getElementById('spinner');
        const errorDiv = document.getElementById('errorMessage');
        const confirmationDiv = document.getElementById('confirmationMessage');

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Ocultar mensajes previos
            errorDiv.style.display = 'none';
            confirmationDiv.style.display = 'none';

            // Mostrar spinner y deshabilitar botón
            spinner.style.display = 'block';
            submitButton.disabled = true;

            const formData = new FormData(form);
            const data = {};
            
            // Recolectar datos. FormData.forEach es clave para manejar repuestos
            formData.forEach((value, key) => {
                // Para checkboxes que no están marcados (no se envían), establecerlos a 'off' o 'undefined'
                if (data[key] === undefined) { 
                    data[key] = value;
                } else {
                    // Manejar repuestos múltiples
                    data[key] = value; 
                }
            });

            // Revisa el estado de los checkboxes no marcados (que FormData omite)
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!formData.has(checkbox.name)) {
                    data[checkbox.name] = undefined; 
                }
            });
            
            // Llamar a la función de GAS para guardar datos
            google.script.run
                .withSuccessHandler(onSuccess)
                .withFailureHandler(onError)
                .processForm(data); // Llama a la función processForm(data)
        });

        function onSuccess(result) {
            spinner.style.display = 'none';
            submitButton.disabled = false;
            
            if (result.success) {
                // Mostrar OT si se generó
                const otMsg = result.ot ? ` (OT: ${result.ot})` : '';
                confirmationDiv.textContent = `Reporte enviado exitosamente${otMsg}.`;
                confirmationDiv.style.display = 'block';
                form.reset(); // Limpiar formulario
                
                // Reiniciar el módulo de repuestos para una nueva entrada
                itemsContainer.innerHTML = '';
                repuestoIndex = 0;
                createRepuestoItem(0); 

            } else {
                onError(result.message || "Error desconocido al procesar el formulario.");
            }
        }

        function onError(error) {
            spinner.style.display = 'none';
            submitButton.disabled = false;
            errorDiv.textContent = 'Error: ' + (error.message || error.toString());
            errorDiv.style.display = 'block';
        }
    });
</script>
</body>
</html>

